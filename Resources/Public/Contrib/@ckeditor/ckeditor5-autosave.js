import{Plugin as b,PendingActions as _}from"@ckeditor/ckeditor5-core";import{DomEmitterMixin as y}from"@ckeditor/ckeditor5-utils";function A(u,e,{signal:i,edges:n}={}){let s,a=null;const d=n!=null&&n.includes("leading"),l=n==null||n.includes("trailing"),o=()=>{a!==null&&(u.apply(s,a),s=void 0,a=null)},c=()=>{l&&o(),f()};let t=null;const h=()=>{t!=null&&clearTimeout(t),t=setTimeout(()=>{t=null,c()},e)},r=()=>{t!==null&&(clearTimeout(t),t=null)},f=()=>{r(),s=void 0,a=null},g=()=>{r(),o()},m=function(...v){if(i?.aborted)return;s=this,a=v;const p=t==null;h(),d&&p&&o()};return m.schedule=h,m.cancel=f,m.flush=g,i?.addEventListener("abort",f,{once:!0}),m}function P(u,e=0,i={}){typeof i!="object"&&(i={});const{leading:n=!1,trailing:s=!0,maxWait:a}=i,d=Array(2);n&&(d[0]="leading"),s&&(d[1]="trailing");let l,o=null;const c=A(function(...r){l=u.apply(this,r),o=null},e,{edges:d}),t=function(...r){return a!=null&&(o===null&&(o=Date.now()),Date.now()-o>=a)?(l=u.apply(this,r),o=Date.now(),c.cancel(),c.schedule(),l):(c.apply(this,r),l)},h=()=>(c.flush(),l);return t.cancel=c.cancel,t.flush=h,t}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class S extends b{adapter;_debouncedSave;_lastDocumentVersion;_savePromise;_domEmitter;_config;_pendingActions;_makeImmediateSave;_action=null;static get pluginName(){return"Autosave"}static get isOfficialPlugin(){return!0}static get requires(){return[_]}constructor(e){super(e);const i=e.config.get("autosave")||{},n=i.waitingTime||1e3;this.set("state","synchronized"),this._debouncedSave=P(this._save.bind(this),n),this._lastDocumentVersion=e.model.document.version,this._savePromise=null,this._domEmitter=new(y()),this._config=i,this._pendingActions=e.plugins.get(_),this._makeImmediateSave=!1}init(){const e=this.editor,i=e.model.document;this.listenTo(e,"ready",()=>{this.listenTo(i,"change:data",(n,s)=>{this._saveCallbacks.length&&s.isLocal&&(this.state==="synchronized"&&(this.state="waiting",this._setPendingAction()),this.state==="waiting"&&this._debouncedSave())})}),this.listenTo(e,"destroy",()=>this._flush(),{priority:"highest"});/* istanbul ignore next -- @preserve */this._domEmitter.listenTo(window,"beforeunload",(n,s)=>{this._pendingActions.hasAny&&(s.returnValue=this._pendingActions.first.message)})}destroy(){this._domEmitter.stopListening(),super.destroy()}save(){return this._debouncedSave.cancel(),this._save()}_flush(){this._debouncedSave.flush()}_save(){return this._savePromise?(this._makeImmediateSave=this.editor.model.document.version>this._lastDocumentVersion,this._savePromise):(this._setPendingAction(),this.state="saving",this._lastDocumentVersion=this.editor.model.document.version,this._savePromise=Promise.resolve().then(()=>Promise.all(this._saveCallbacks.map(e=>e(this.editor)))).finally(()=>{this._savePromise=null}).then(()=>{if(this._makeImmediateSave)return this._makeImmediateSave=!1,this._save();this.editor.model.document.version>this._lastDocumentVersion?(this.state="waiting",this._debouncedSave()):(this.state="synchronized",this._pendingActions.remove(this._action),this._action=null)}).catch(e=>{throw this.state="error",this.state="saving",this._debouncedSave(),e}),this._savePromise)}_setPendingAction(){const e=this.editor.t;this._action||(this._action=this._pendingActions.add(e("Saving changes")))}get _saveCallbacks(){const e=[];return this.adapter&&this.adapter.save&&e.push(this.adapter.save),this._config.save&&e.push(this._config.save),e}}export{S as Autosave};
