import{Plugin as f,Command as N,PendingActions as K}from"@ckeditor/ckeditor5-core";import{ButtonView as A,MenuBarMenuListItemButtonView as D,Notification as T}from"@ckeditor/ckeditor5-ui";import{IconBrowseFiles as V,IconImageAssetManager as B,IconCkboxImageEdit as pe}from"@ckeditor/ckeditor5-icons";import{ModelRange as be}from"@ckeditor/ckeditor5-engine";import{createElement as H,toMap as ke,CKEditorError as C,logError as O,global as z,delay as Ie,abortableDebounce as xe,retry as we}from"@ckeditor/ckeditor5-utils";import{FileRepository as W}from"@ckeditor/ckeditor5-upload";/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class $ extends f{static get pluginName(){return"CKBoxUI"}static get isOfficialPlugin(){return!0}afterInit(){const e=this.editor;e.commands.get("ckbox")&&(e.ui.componentFactory.add("ckbox",()=>this._createFileToolbarButton()),e.ui.componentFactory.add("menuBar:ckbox",()=>this._createFileMenuBarButton()),e.plugins.has("ImageInsertUI")&&e.plugins.get("ImageInsertUI").registerIntegration({name:"assetManager",observable:()=>e.commands.get("ckbox"),buttonViewCreator:()=>this._createImageToolbarButton(),formViewCreator:()=>this._createImageDropdownButton(),menuBarButtonViewCreator:t=>this._createImageMenuBarButton(t?"insertOnly":"insertNested")}))}_createButton(e){const t=this.editor,o=t.locale,n=new e(o),r=t.commands.get("ckbox");return n.bind("isOn","isEnabled").to(r,"value","isEnabled"),n.on("execute",()=>{t.execute("ckbox")}),n}_createFileToolbarButton(){const e=this.editor.locale.t,t=this._createButton(A);return t.icon=V,t.label=e("Open file manager"),t.tooltip=!0,t}_createImageToolbarButton(){const e=this.editor.locale.t,t=this.editor.plugins.get("ImageInsertUI"),o=this._createButton(A);return o.icon=B,o.bind("label").to(t,"isImageSelected",n=>e(n?"Replace image with file manager":"Insert image with file manager")),o.tooltip=!0,o}_createImageDropdownButton(){const e=this.editor.locale.t,t=this.editor.plugins.get("ImageInsertUI"),o=this._createButton(A);return o.icon=B,o.withText=!0,o.bind("label").to(t,"isImageSelected",n=>e(n?"Replace with file manager":"Insert with file manager")),o.on("execute",()=>{t.dropdownView.isOpen=!1}),o}_createFileMenuBarButton(){const e=this.editor.locale.t,t=this._createButton(D);return t.icon=V,t.withText=!0,t.label=e("File"),t}_createImageMenuBarButton(e){const t=this.editor.locale.t,o=this.editor.locale.t,n=this._createButton(D);switch(n.icon=B,n.withText=!0,e){case"insertOnly":n.label=t("Image");break;case"insertNested":n.label=o("With file manager");break}return n}}var ye=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","#","$","%","*","+",",","-",".",":",";","=","?","@","[","]","^","_","{","|","}","~"],b=i=>{let e=0;for(let t=0;t<i.length;t++){let o=i[t],n=ye.indexOf(o);e=e*83+n}return e},S=i=>{let e=i/255;return e<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)},P=i=>{let e=Math.max(0,Math.min(1,i));return e<=.0031308?Math.trunc(e*12.92*255+.5):Math.trunc((1.055*Math.pow(e,.4166666666666667)-.055)*255+.5)},_e=i=>i<0?-1:1,L=(i,e)=>_e(i)*Math.pow(Math.abs(i),e),q=class extends Error{constructor(i){super(i),this.name="ValidationError",this.message=i}},Ae=i=>{if(!i||i.length<6)throw new q("The blurhash string must be at least 6 characters");let e=b(i[0]),t=Math.floor(e/9)+1,o=e%9+1;if(i.length!==4+2*o*t)throw new q(`blurhash length mismatch: length is ${i.length} but it should be ${4+2*o*t}`)},Ce=i=>{let e=i>>16,t=i>>8&255,o=i&255;return[S(e),S(t),S(o)]},Ee=(i,e)=>{let t=Math.floor(i/361),o=Math.floor(i/19)%19,n=i%19;return[L((t-9)/9,2)*e,L((o-9)/9,2)*e,L((n-9)/9,2)*e]},ve=(i,e,t,o)=>{Ae(i),o=o|1;let n=b(i[0]),r=Math.floor(n/9)+1,s=n%9+1,a=(b(i[1])+1)/166,c=new Array(s*r);for(let u=0;u<c.length;u++)if(u===0){let g=b(i.substring(2,6));c[u]=Ce(g)}else{let g=b(i.substring(4+u*2,6+u*2));c[u]=Ee(g,a*o)}let d=e*4,l=new Uint8ClampedArray(d*t);for(let u=0;u<t;u++)for(let g=0;g<e;g++){let m=0,h=0,R=0;for(let y=0;y<r;y++)for(let _=0;_<s;_++){let v=Math.cos(Math.PI*g*_/e)*Math.cos(Math.PI*u*y/t),U=c[_+y*s];m+=U[0]*v,h+=U[1]*v,R+=U[2]*v}let me=P(m),he=P(h),fe=P(R);l[4*g+0+u*d]=me,l[4*g+1+u*d]=he,l[4*g+2+u*d]=fe,l[4*g+3+u*d]=255}return l},Ue=ve;/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function j(i){const e=[];let t=0;for(const n in i){const r=parseInt(n,10);isNaN(r)||(r>t&&(t=r),e.push(`${i[n]} ${n}w`))}const o=[{srcset:e.join(","),sizes:`(max-width: ${t}px) 100vw, ${t}px`,type:"image/webp"}];return{imageFallbackUrl:i.default,imageSources:o}}function Q(i,e){const[,t]=i.value.split("."),o=JSON.parse(atob(t)),n=o.auth?.ckbox?.workspaces||[o.aud];return e?o.auth?.ckbox?.role=="superadmin"||n.includes(e)?e:null:n[0]}const k=32;function G(i){if(i)try{const e=`${k}px`,t=document.createElement("canvas");t.setAttribute("width",e),t.setAttribute("height",e);const o=t.getContext("2d");/* istanbul ignore next -- @preserve */if(!o)return;const n=o.createImageData(k,k),r=Ue(i,k,k);return n.data.set(r),o.putImageData(n,0,0),t.toDataURL()}catch{return}}function I({url:i,method:e="GET",data:t,onUploadProgress:o,signal:n,authorization:r}){const s=new XMLHttpRequest;s.open(e,i.toString()),s.setRequestHeader("Authorization",r),s.setRequestHeader("CKBox-Version","CKEditor 5"),s.responseType="json";const a=()=>{s.abort()};return new Promise((c,d)=>{n.throwIfAborted(),n.addEventListener("abort",a),s.addEventListener("loadstart",()=>{n.addEventListener("abort",a)}),s.addEventListener("loadend",()=>{n.removeEventListener("abort",a)}),s.addEventListener("error",()=>{d()}),s.addEventListener("abort",()=>{d()}),s.addEventListener("load",()=>{const l=s.response;if(!l||l.statusCode>=400)return d(l&&l.message);c(l)});/* istanbul ignore else -- @preserve */o&&s.upload.addEventListener("progress",l=>{o(l)}),s.send(t)})}const Te={"image/gif":"gif","image/jpeg":"jpg","image/png":"png","image/webp":"webp","image/bmp":"bmp","image/tiff":"tiff"};function X(i){return Te[i]}async function J(i,e){try{const t=await fetch(i,{method:"HEAD",cache:"force-cache",...e});return t.ok&&t.headers.get("content-type")||""}catch{return""}}function Y(i){const e=i.name,t=/\.(?<ext>[^.]+)$/;return e.match(t).groups.ext.toLowerCase()}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/const Be=1e3;class Z extends N{_chosenAssets=new Set;_wrapper=null;constructor(e){super(e),this._initListeners()}refresh(){this.value=this._getValue(),this.isEnabled=this._checkEnabled()}execute(){this.fire("ckbox:open")}_getValue(){return this._wrapper!==null}_checkEnabled(){const e=this.editor.commands.get("insertImage"),t=this.editor.commands.get("link");return!(!e.isEnabled&&!t.isEnabled)}_prepareOptions(){const t=this.editor.config.get("ckbox"),o=t.dialog,n=t.categories,r=t.view,s=t.upload;return{theme:t.theme,language:t.language,tokenUrl:t.tokenUrl,serviceOrigin:t.serviceOrigin,forceDemoLabel:t.forceDemoLabel,choosableFileExtensions:t.choosableFileExtensions,assets:{onChoose:a=>this.fire("ckbox:choose",a)},dialog:{onClose:()=>this.fire("ckbox:close"),width:o&&o.width,height:o&&o.height},categories:n&&{icons:n.icons},view:r&&{openLastView:r.openLastView,startupFolderId:r.startupFolderId,startupCategoryId:r.startupCategoryId,hideMaximizeButton:r.hideMaximizeButton},upload:s&&{componentsHideTimeout:s.componentsHideTimeout,dialogMinimizeTimeout:s.dialogMinimizeTimeout}}}_initListeners(){const e=this.editor,t=e.model,o=!e.config.get("ckbox.ignoreDataId"),n=e.config.get("ckbox.downloadableFiles");this.on("ckbox",()=>{this.refresh()},{priority:"low"}),this.on("ckbox:open",()=>{!this.isEnabled||this.value||(this._wrapper=H(document,"div",{class:"ck ckbox-wrapper"}),document.body.appendChild(this._wrapper),window.CKBox.mount(this._wrapper,this._prepareOptions()))}),this.on("ckbox:close",()=>{this.value&&(this._wrapper.remove(),this._wrapper=null,e.editing.view.focus())}),this.on("ckbox:choose",(r,s)=>{if(!this.isEnabled)return;const a=e.commands.get("insertImage"),c=e.commands.get("link"),d=Oe({assets:s,downloadableFilesConfig:n,isImageAllowed:a.isEnabled,isLinkAllowed:c.isEnabled}),l=d.length;l!==0&&(t.change(u=>{for(const g of d){const m=g===d[l-1],h=l===1;this._insertAsset(g,m,u,h),o&&(setTimeout(()=>this._chosenAssets.delete(g),Be),this._chosenAssets.add(g))}}),e.editing.view.focus())}),this.listenTo(e,"destroy",()=>{this.fire("ckbox:close"),this._chosenAssets.clear()})}_insertAsset(e,t,o,n){const a=this.editor.model.document.selection;o.removeSelectionAttribute("linkHref"),e.type==="image"?this._insertImage(e):this._insertLink(e,o,n),t||o.setSelection(a.getLastPosition())}_insertImage(e){const t=this.editor,{imageFallbackUrl:o,imageSources:n,imageTextAlternative:r,imageWidth:s,imageHeight:a,imagePlaceholder:c}=e.attributes;t.execute("insertImage",{source:{src:o,sources:n,alt:r,width:s,height:a,...c?{placeholder:c}:null}})}_insertLink(e,t,o){const n=this.editor,r=n.model,s=r.document.selection,{linkName:a,linkHref:c}=e.attributes;if(s.isCollapsed){const d=ke(s.getAttributes()),l=t.createText(a,d);if(!o){const g=s.getLastPosition(),m=g.parent;m.name==="paragraph"&&m.isEmpty||n.execute("insertParagraph",{position:g});const h=r.insertContent(l);t.setSelection(h),n.execute("link",c);return}const u=r.insertContent(l);t.setSelection(u)}n.execute("link",c)}}function Oe({downloadableFilesConfig:i,assets:e,isImageAllowed:t,isLinkAllowed:o}){return e.map(n=>Pe(n)?{id:n.data.id,type:"image",attributes:F(n)}:{id:n.data.id,type:"link",attributes:Se(n,i)}).filter(n=>n.type==="image"?t:o)}function F(i){const{imageFallbackUrl:e,imageSources:t}=j(i.data.imageUrls),{description:o,width:n,height:r,blurHash:s}=i.data.metadata,a=G(s);return{imageFallbackUrl:e,imageSources:t,imageTextAlternative:o||"",imageWidth:n,imageHeight:r,...a?{imagePlaceholder:a}:null}}function Se(i,e){return{linkName:i.data.name,linkHref:Le(i,e)}}function Pe(i){const e=i.data.metadata;return e?e.width&&e.height:!1}function Le(i,e){const t=new URL(i.data.url);return je(i,e)&&t.searchParams.set("download","true"),t.toString()}function je(i,e){return typeof e=="function"?e(i):!0}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/const Fe="lark";class p extends f{_token;static get pluginName(){return"CKBoxUtils"}static get isOfficialPlugin(){return!0}static get requires(){return["CloudServices"]}init(){const e=this.editor,t=!!e.config.get("ckbox"),o=!!window.CKBox;if(!t&&!o)return;e.config.define("ckbox",{serviceOrigin:"https://api.ckbox.io",defaultUploadCategories:null,ignoreDataId:!1,language:e.locale.uiLanguage,theme:Fe,tokenUrl:e.config.get("cloudServices.tokenUrl")});const n=e.plugins.get("CloudServices"),r=e.config.get("cloudServices.tokenUrl"),s=e.config.get("ckbox.tokenUrl");if(!s)throw new C("ckbox-plugin-missing-token-url",this);s==r?this._token=Promise.resolve(n.token):this._token=n.registerTokenUrl(s),this._token=this._token.then(async a=>(await this._authorizePrivateCategoriesAccess(a.value),a))}getToken(){return this._token}async getWorkspaceId(){const e=this.editor.t,t=e("Cannot access default workspace."),o=this.editor.config.get("ckbox.defaultUploadWorkspaceId"),n=Q(await this._token,o);if(n==null)throw O("ckbox-access-default-workspace-error"),t;return n}async getCategoryIdForFile(e,t){const o=this.editor.t,n=o("Cannot determine a category for the uploaded file."),r=this.editor.config.get("ckbox.defaultUploadCategories"),s=this._getAvailableCategories(t),a=typeof e=="string"?X(await J(e,t)):Y(e),c=await s;if(!c)throw n;if(r){const l=Object.keys(r).find(u=>r[u].find(g=>g.toLowerCase()==a));if(l){const u=c.find(g=>g.id===l||g.name===l);if(!u)throw n;return u.id}}const d=c.find(l=>l.extensions.find(u=>u.toLowerCase()==a));if(!d)throw n;return d.id}async _getAvailableCategories(e){const o=this.editor,n=this._token,{signal:r}=e,s=o.config.get("ckbox.serviceOrigin"),a=await this.getWorkspaceId();try{const d=[];let l=0,u;do{const g=await c(l);d.push(...g.items),u=g.totalCount-(l+50),l+=50}while(u>0);return d}catch{r.throwIfAborted(),O("ckbox-fetch-category-http-error");return}async function c(d){const l=new URL("categories",s);return l.searchParams.set("limit",String(50)),l.searchParams.set("offset",String(d)),l.searchParams.set("workspaceId",a),I({url:l,signal:r,authorization:(await n).value})}}async _authorizePrivateCategoriesAccess(e){const t=this.editor.config.get("ckbox.serviceOrigin"),o=new FormData;o.set("token",e),await fetch(`${t}/categories/authorizePrivateAccess`,{method:"POST",credentials:"include",mode:"no-cors",body:o})}}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class ee extends f{static get requires(){return["ImageUploadEditing","ImageUploadProgress",W,E]}static get pluginName(){return"CKBoxUploadAdapter"}static get isOfficialPlugin(){return!0}async afterInit(){const e=this.editor,t=!!e.config.get("ckbox"),o=!!window.CKBox;if(!t&&!o)return;const n=e.plugins.get(W),r=e.plugins.get(p);n.createUploadAdapter=c=>new Me(c,e,r);const s=!e.config.get("ckbox.ignoreDataId"),a=e.plugins.get("ImageUploadEditing");s&&a.on("uploadComplete",(c,{imageElement:d,data:l})=>{e.model.change(u=>{u.setAttribute("ckboxImageId",l.ckboxImageId,d)})})}}class Me{loader;token;editor;controller;serviceOrigin;ckboxUtils;constructor(e,t,o){this.loader=e,this.token=o.getToken(),this.ckboxUtils=o,this.editor=t,this.controller=new AbortController,this.serviceOrigin=t.config.get("ckbox.serviceOrigin")}async upload(){const e=this.ckboxUtils,t=this.editor.t,o=await this.loader.file,n=await e.getCategoryIdForFile(o,{signal:this.controller.signal}),r=new URL("assets",this.serviceOrigin),s=new FormData;r.searchParams.set("workspaceId",await e.getWorkspaceId()),s.append("categoryId",n),s.append("file",o);const a={method:"POST",url:r,data:s,onUploadProgress:c=>{/* istanbul ignore else -- @preserve */c.lengthComputable&&(this.loader.uploadTotal=c.total,this.loader.uploaded=c.loaded)},signal:this.controller.signal,authorization:(await this.token).value};return I(a).then(async c=>{const d=j(c.imageUrls);return{ckboxImageId:c.id,default:d.imageFallbackUrl,sources:d.imageSources}}).catch(()=>{const c=t("Cannot upload file:")+` ${o.name}.`;return Promise.reject(c)})}abort(){this.controller.abort()}}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/const te="NoPermission";class E extends f{static get pluginName(){return"CKBoxEditing"}static get isOfficialPlugin(){return!0}static get requires(){return["LinkEditing","PictureEditing",ee,p]}init(){const e=this.editor;this._shouldBeInitialised()&&(this._checkImagePlugins(),oe()&&e.commands.add("ckbox",new Z(e)),Ve(e).then(t=>{t||this._blockImageCommands()}))}afterInit(){const e=this.editor;this._shouldBeInitialised()&&(e.config.get("ckbox.ignoreDataId")||(this._initSchema(),this._initConversion(),this._initFixers()))}_shouldBeInitialised(){return!!this.editor.config.get("ckbox")||oe()}_blockImageCommands(){const e=this.editor,t=e.commands.get("uploadImage"),o=e.commands.get("ckboxImageEdit");t&&(t.isAccessAllowed=!1,t.forceDisabled(te)),o&&o.forceDisabled(te)}_checkImagePlugins(){const e=this.editor;!e.plugins.has("ImageBlockEditing")&&!e.plugins.has("ImageInlineEditing")&&O("ckbox-plugin-image-feature-missing",e)}_initSchema(){const t=this.editor.model.schema;t.extend("$text",{allowAttributes:"ckboxLinkId"}),t.isRegistered("imageBlock")&&t.extend("imageBlock",{allowAttributes:["ckboxImageId","ckboxLinkId"]}),t.isRegistered("imageInline")&&t.extend("imageInline",{allowAttributes:["ckboxImageId","ckboxLinkId"]}),t.addAttributeCheck(o=>{if(!o.last.getAttribute("linkHref"))return!1},"ckboxLinkId")}_initConversion(){const e=this.editor;e.conversion.for("downcast").add(o=>{o.on("attribute:ckboxLinkId:imageBlock",(n,r,s)=>{const{writer:a,mapper:c,consumable:d}=s;if(!d.consume(r.item,n.name))return;const u=[...c.toViewElement(r.item).getChildren()].find(g=>g.name==="a");u&&(r.item.hasAttribute("ckboxLinkId")?a.setAttribute("data-ckbox-resource-id",r.item.getAttribute("ckboxLinkId"),u):a.removeAttribute("data-ckbox-resource-id",u))},{priority:"low"}),o.on("attribute:ckboxLinkId",(n,r,s)=>{const{writer:a,mapper:c,consumable:d}=s;if(d.consume(r.item,n.name)){if(r.attributeOldValue){const l=ie(a,r.attributeOldValue);a.unwrap(c.toViewRange(r.range),l)}if(r.attributeNewValue){const l=ie(a,r.attributeNewValue);if(r.item.is("selection")){const u=a.document.selection;a.wrap(u.getFirstRange(),l)}else a.wrap(c.toViewRange(r.range),l)}}},{priority:"low"})}),e.conversion.for("upcast").add(o=>{o.on("element:a",(n,r,s)=>{const{writer:a,consumable:c}=s;if(!r.viewItem.getAttribute("href"))return;const d={attributes:["data-ckbox-resource-id"]};if(!c.consume(r.viewItem,d))return;const l=r.viewItem.getAttribute("data-ckbox-resource-id");if(l)if(r.modelRange)for(let u of r.modelRange.getItems())u.is("$textProxy")&&(u=u.textNode),De(u)&&a.setAttribute("ckboxLinkId",l,u);else{const u=r.modelCursor.nodeBefore||r.modelCursor.parent;a.setAttribute("ckboxLinkId",l,u)}},{priority:"low"})}),e.conversion.for("downcast").attributeToAttribute({model:"ckboxImageId",view:"data-ckbox-resource-id"}),e.conversion.for("upcast").elementToAttribute({model:{key:"ckboxImageId",value:o=>o.getAttribute("data-ckbox-resource-id")},view:{attributes:{"data-ckbox-resource-id":/[\s\S]+/}}});const t=e.commands.get("replaceImageSource");t&&this.listenTo(t,"cleanupImage",(o,[n,r])=>{n.removeAttribute("ckboxImageId",r)})}_initFixers(){const e=this.editor,t=e.model,o=t.document.selection;t.document.registerPostFixer(Re(e)),t.document.registerPostFixer(Ne(o))}}function Re(i){return e=>{let t=!1;const o=i.model,n=i.commands.get("ckbox");if(!n)return t;for(const r of o.document.differ.getChanges()){if(r.type!=="insert"&&r.type!=="attribute")continue;const s=r.type==="insert"?new be(r.position,r.position.getShiftedBy(r.length)):r.range,a=r.type==="attribute"&&r.attributeKey==="linkHref"&&r.attributeNewValue===null;for(const c of s.getItems()){if(a&&c.hasAttribute("ckboxLinkId")){e.removeAttribute("ckboxLinkId",c),t=!0;continue}const d=Ke(c,n._chosenAssets);for(const l of d){const u=l.type==="image"?"ckboxImageId":"ckboxLinkId";l.id!==c.getAttribute(u)&&(e.setAttribute(u,l.id,c),t=!0)}}}return t}}function Ne(i){return e=>!i.hasAttribute("linkHref")&&i.hasAttribute("ckboxLinkId")?(e.removeSelectionAttribute("ckboxLinkId"),!0):!1}function Ke(i,e){const t=i.is("element","imageInline")||i.is("element","imageBlock"),o=i.hasAttribute("linkHref");return[...e].filter(n=>{if(n.type==="image"&&t)return n.attributes.imageFallbackUrl===i.getAttribute("src");if(n.type==="link"&&o)return n.attributes.linkHref===i.getAttribute("linkHref")})}function ie(i,e){const t=i.createAttributeElement("a",{"data-ckbox-resource-id":e},{priority:5});return i.setCustomProperty("link",!0,t),t}function De(i){return!!(i.is("$text")||i.is("element","imageInline")||i.is("element","imageBlock"))}function oe(){return!!window.CKBox}async function Ve(i){const e=i.plugins.get(p),t=i.config.get("ckbox.serviceOrigin"),o=new URL("permissions",t),{value:n}=await e.getToken(),r=await I({url:o,authorization:n,signal:new AbortController().signal});return Object.values(r).some(s=>s["asset:create"])}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class He extends f{static get pluginName(){return"CKBox"}static get isOfficialPlugin(){return!0}static get requires(){return[E,$]}}function ze(i,e){return i===e||Number.isNaN(i)&&Number.isNaN(e)}function ne(i){return Object.getOwnPropertySymbols(i).filter(e=>Object.prototype.propertyIsEnumerable.call(i,e))}function re(i){return i==null?i===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(i)}const We="[object RegExp]",$e="[object String]",qe="[object Number]",Qe="[object Boolean]",se="[object Arguments]",Ge="[object Symbol]",Xe="[object Date]",Je="[object Map]",Ye="[object Set]",Ze="[object Array]",et="[object Function]",tt="[object ArrayBuffer]",M="[object Object]",it="[object Error]",ot="[object DataView]",nt="[object Uint8Array]",rt="[object Uint8ClampedArray]",st="[object Uint16Array]",at="[object Uint32Array]",ct="[object BigUint64Array]",lt="[object Int8Array]",ut="[object Int16Array]",dt="[object Int32Array]",gt="[object BigInt64Array]",mt="[object Float32Array]",ht="[object Float64Array]";function ae(i){if(!i||typeof i!="object")return!1;const e=Object.getPrototypeOf(i);return e===null||e===Object.prototype||Object.getPrototypeOf(e)===null?Object.prototype.toString.call(i)==="[object Object]":!1}function ft(i,e,t){return x(i,e,void 0,void 0,void 0,void 0,t)}function x(i,e,t,o,n,r,s){const a=s(i,e,t,o,n,r);if(a!==void 0)return a;if(typeof i==typeof e)switch(typeof i){case"bigint":case"string":case"boolean":case"symbol":case"undefined":return i===e;case"number":return i===e||Object.is(i,e);case"function":return i===e;case"object":return w(i,e,r,s)}return w(i,e,r,s)}function w(i,e,t,o){if(Object.is(i,e))return!0;let n=re(i),r=re(e);if(n===se&&(n=M),r===se&&(r=M),n!==r)return!1;switch(n){case $e:return i.toString()===e.toString();case qe:{const c=i.valueOf(),d=e.valueOf();return ze(c,d)}case Qe:case Xe:case Ge:return Object.is(i.valueOf(),e.valueOf());case We:return i.source===e.source&&i.flags===e.flags;case et:return i===e}t=t??new Map;const s=t.get(i),a=t.get(e);if(s!=null&&a!=null)return s===e;t.set(i,e),t.set(e,i);try{switch(n){case Je:{if(i.size!==e.size)return!1;for(const[c,d]of i.entries())if(!e.has(c)||!x(d,e.get(c),c,i,e,t,o))return!1;return!0}case Ye:{if(i.size!==e.size)return!1;const c=Array.from(i.values()),d=Array.from(e.values());for(let l=0;l<c.length;l++){const u=c[l],g=d.findIndex(m=>x(u,m,void 0,i,e,t,o));if(g===-1)return!1;d.splice(g,1)}return!0}case Ze:case nt:case rt:case st:case at:case ct:case lt:case ut:case dt:case gt:case mt:case ht:{if(typeof Buffer<"u"&&Buffer.isBuffer(i)!==Buffer.isBuffer(e)||i.length!==e.length)return!1;for(let c=0;c<i.length;c++)if(!x(i[c],e[c],c,i,e,t,o))return!1;return!0}case tt:return i.byteLength!==e.byteLength?!1:w(new Uint8Array(i),new Uint8Array(e),t,o);case ot:return i.byteLength!==e.byteLength||i.byteOffset!==e.byteOffset?!1:w(new Uint8Array(i),new Uint8Array(e),t,o);case it:return i.name===e.name&&i.message===e.message;case M:{if(!(w(i.constructor,e.constructor,t,o)||ae(i)&&ae(e)))return!1;const d=[...Object.keys(i),...ne(i)],l=[...Object.keys(e),...ne(e)];if(d.length!==l.length)return!1;for(let u=0;u<d.length;u++){const g=d[u],m=i[g];if(!Object.hasOwn(e,g))return!1;const h=e[g];if(!x(m,h,g,i,e,t,o))return!1}return!0}default:return!1}}finally{t.delete(i),t.delete(e)}}function pt(){}function bt(i,e){return ft(i,e,pt)}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function ce(i){const e=le(i);return t=>t.is("element","imageInline")||t.is("element","imageBlock")?t.hasAttribute("ckboxImageId")?!0:t.hasAttribute("src")?e(t.getAttribute("src")):!1:!1}function le(i){if(Array.isArray(i)){const e=i.map(le);return t=>e.some(o=>o(t))}if(i=="origin"){const e=z.window.location.origin;return t=>new URL(t,z.document.baseURI).origin==e}return typeof i=="function"?i:i instanceof RegExp?e=>!!(e.match(i)||e.replace(/^https?:\/\//,"").match(i)):()=>!1}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class ue extends N{_wrapper=null;_processInProgress=new Set;_canEdit;_prepareOptions;_updateUiDelayed=Ie(()=>this.editor.ui.update(),0);constructor(e){super(e),this.value=!1,this._canEdit=ce(e.config.get("ckbox.allowExternalImagesEditing")),this._prepareOptions=xe((t,o)=>this._prepareOptionsAbortable(t,o)),this._prepareListeners()}refresh(){const e=this.editor;this.value=this._getValue();const t=e.model.document.selection.getSelectedElement();this.isEnabled=!!t&&this._canEdit(t)&&!this._checkIfElementIsBeingProcessed(t)}execute(){if(this._getValue())return;const e=H(document,"div",{class:"ck ckbox-wrapper"});this._wrapper=e,this.value=!0,document.body.appendChild(this._wrapper);const o={element:this.editor.model.document.selection.getSelectedElement(),controller:new AbortController};this._prepareOptions(o).then(n=>window.CKBox.mountImageEditor(e,n),n=>{const r=this.editor,s=r.t;r.plugins.get(T).showWarning(s("Failed to determine category of edited image."),{namespace:"ckbox"}),console.error(n),this._handleImageEditorClose()})}destroy(){this._handleImageEditorClose(),this._prepareOptions.abort(),this._updateUiDelayed.cancel();for(const e of this._processInProgress.values())e.controller.abort();super.destroy()}_getValue(){return this._wrapper!==null}async _prepareOptionsAbortable(e,t){const o=this.editor,n=o.config.get("ckbox"),r=o.plugins.get(p),{element:s}=t;let a;const c=s.getAttribute("ckboxImageId");if(c)a={assetId:c};else{const d=new URL(s.getAttribute("src"),document.baseURI).href,l=await r.getCategoryIdForFile(d,{signal:e});a={imageUrl:d,uploadCategoryId:l}}return{...a,imageEditing:{allowOverwrite:!1},tokenUrl:n.tokenUrl,...n.serviceOrigin&&{serviceOrigin:n.serviceOrigin},onClose:()=>this._handleImageEditorClose(),onSave:d=>this._handleImageEditorSave(t,d)}}_prepareListeners(){this.listenTo(this.editor.model.document,"change:data",()=>{this._getProcessingStatesOfDeletedImages().forEach(t=>{t.controller.abort()})})}_getProcessingStatesOfDeletedImages(){const e=[];for(const t of this._processInProgress.values())t.element.root.rootName=="$graveyard"&&e.push(t);return e}_checkIfElementIsBeingProcessed(e){for(const{element:t}of this._processInProgress)if(bt(t,e))return!0;return!1}_handleImageEditorClose(){this._wrapper&&(this._wrapper.remove(),this._wrapper=null,this.editor.editing.view.focus(),this._updateUiDelayed(),this.refresh())}_handleImageEditorSave(e,t){const o=this.editor.locale.t,n=this.editor.plugins.get(T),r=this.editor.plugins.get(K),s=r.add(o("Processing the edited image."));this._processInProgress.add(e),this._showImageProcessingIndicator(e.element,t),this.refresh(),this._waitForAssetProcessed(t.data.id,e.controller.signal).then(a=>{this._replaceImage(e.element,a)},a=>{this.editor.editing.reconvertItem(e.element),!e.controller.signal.aborted&&(!a||a instanceof C?n.showWarning(o("Server failed to process the image."),{namespace:"ckbox"}):console.error(a))}).finally(()=>{this._processInProgress.delete(e),r.remove(s),this.refresh()})}async _getAssetStatusFromServer(e,t){const o=this.editor.plugins.get(p),n=new URL("assets/"+e,this.editor.config.get("ckbox.serviceOrigin")),r=await I({url:n,signal:t,authorization:(await o.getToken()).value}),s=r.metadata.metadataProcessingStatus;if(!s||s=="queued")throw new C("ckbox-image-not-processed");return{data:{...r}}}async _waitForAssetProcessed(e,t){const o=await we(()=>this._getAssetStatusFromServer(e,t),{signal:t,maxAttempts:5});if(o.data.metadata.metadataProcessingStatus!="success")throw new C("ckbox-image-processing-failed");return o}_showImageProcessingIndicator(e,t){const o=this.editor;o.editing.view.change(n=>{const r=o.editing.mapper.toViewElement(e),a=this.editor.plugins.get("ImageUtils").findViewImgElement(r);n.removeStyle("aspect-ratio",a),n.setAttribute("width",t.data.metadata.width,a),n.setAttribute("height",t.data.metadata.height,a),n.setStyle("width",`${t.data.metadata.width}px`,a),n.setStyle("height",`${t.data.metadata.height}px`,a),n.addClass("image-processing",r)})}_replaceImage(e,t){const o=this.editor,{imageFallbackUrl:n,imageSources:r,imageWidth:s,imageHeight:a,imagePlaceholder:c}=F(t),d=Array.from(o.model.document.selection.getRanges());o.model.change(l=>{l.setSelection(e,"on"),o.execute("insertImage",{imageType:e.is("element","imageInline")?"imageInline":null,source:{src:n,sources:r,width:s,height:a,...c?{placeholder:c}:null,...e.hasAttribute("alt")?{alt:e.getAttribute("alt")}:null}});const u=e.getChildren();e=o.model.document.selection.getSelectedElement();for(const g of u)l.append(l.cloneElement(g),e);l.setAttribute("ckboxImageId",t.data.id,e),l.setSelection(d)})}}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class de extends f{static get pluginName(){return"CKBoxImageEditEditing"}static get isOfficialPlugin(){return!0}static get requires(){return[E,p,K,T,"ImageUtils","ImageEditing"]}init(){const{editor:e}=this;e.commands.add("ckboxImageEdit",new ue(e))}}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class ge extends f{static get pluginName(){return"CKBoxImageEditUI"}static get isOfficialPlugin(){return!0}init(){const e=this.editor;e.ui.componentFactory.add("ckboxImageEdit",t=>{const o=e.commands.get("ckboxImageEdit"),n=e.commands.get("uploadImage"),r=new A(t),s=t.t;return r.set({icon:pe,tooltip:!0}),r.bind("label").to(n,"isAccessAllowed",a=>s(a?"Edit image":"You have no image editing permissions.")),r.bind("isOn").to(o,"value",o,"isEnabled",(a,c)=>a&&c),r.bind("isEnabled").to(o),this.listenTo(r,"execute",()=>{e.execute("ckboxImageEdit"),e.editing.view.focus()}),r})}}function kt(i,{insertAt:e}={}){if(typeof document>"u")return;const t=document.head||document.getElementsByTagName("head")[0],o=document.createElement("style");o.type="text/css",window.litNonce&&o.setAttribute("nonce",window.litNonce),e==="top"&&t.firstChild?t.insertBefore(o,t.firstChild):t.appendChild(o),o.styleSheet?o.styleSheet.cssText=i:o.appendChild(document.createTextNode(i))}kt(':root{--ck-image-processing-highlight-color:#f9fafa;--ck-image-processing-background-color:#e3e5e8}.ck.ck-editor__editable .image.image-processing{position:relative}.ck.ck-editor__editable .image.image-processing:before{animation:ck-image-processing-animation 2s linear infinite;background:linear-gradient(90deg,var(--ck-image-processing-background-color),var(--ck-image-processing-highlight-color),var(--ck-image-processing-background-color));background-size:200% 100%;content:"";height:100%;left:0;position:absolute;top:0;width:100%;z-index:1}.ck.ck-editor__editable .image.image-processing img{height:100%}@keyframes ck-image-processing-animation{0%{background-position:200% 0}to{background-position:-200% 0}}');/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class It extends f{static get pluginName(){return"CKBoxImageEdit"}static get isOfficialPlugin(){return!0}static get requires(){return[de,ge]}}export{He as CKBox,Z as CKBoxCommand,E as CKBoxEditing,It as CKBoxImageEdit,ue as CKBoxImageEditCommand,de as CKBoxImageEditEditing,ge as CKBoxImageEditUI,$ as CKBoxUI,ee as CKBoxUploadAdapter,p as CKBoxUtils,X as _ckBoxConvertMimeTypeToExtension,G as _ckboxBlurHashToDataUrl,ce as _createCKBoxEditabilityChecker,J as _getCKBoxContentTypeOfUrl,Y as _getCKBoxFileExtension,j as _getCKBoxImageUrls,Q as _getCKBoxWorkspaceId,F as _prepareCKBoxImageAssetAttributes,I as _sendCKBoxHttpRequest};
