import{Command as b,Plugin as f}from"@ckeditor/ckeditor5-core";import{Matcher as F}from"@ckeditor/ckeditor5-engine";import{IconContentLock as w,IconContentUnlock as D}from"@ckeditor/ckeditor5-icons";import{createDropdown as V,addListToDropdown as O,MenuBarMenuView as H,MenuBarMenuListView as L,MenuBarMenuListItemView as q,MenuBarMenuListItemButtonView as _,UIModel as $,ButtonView as W}from"@ckeditor/ckeditor5-ui";import{Collection as U}from"@ckeditor/ckeditor5-utils";/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class h extends b{_direction;constructor(e,t){super(e),this.affectsData=!1,this._direction=t}refresh(){this.isEnabled=this._checkEnabled()}execute(){const e=R(this.editor.model,this._direction);e&&this.editor.model.change(t=>{t.setSelection(e)})}_checkEnabled(){return!!R(this.editor.model,this._direction)}}function R(r,e){const i=r.document.selection.getFirstPosition(),n=[];for(const o of r.markers.getMarkersGroup("restrictedEditingException")){const s=o.getRange(),c=i.isTouching(s.start)&&i.hasSameParentAs(s.start)||i.isTouching(s.end)&&i.hasSameParentAs(s.end);s.containsPosition(i)||c||(e==="forward"&&s.start.isAfter(i)||e==="backward"&&s.end.isBefore(i))&&n.push(s)}if(n.length)return n.sort((o,s)=>e==="forward"?o.start.isAfter(s.start)?1:-1:o.start.isBefore(s.start)?1:-1).shift()}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function g(r,e){for(const t of r.model.markers){const i=t.getRange();if(E(i,e)&&t.name.startsWith("restrictedEditingException:"))return t}}function E(r,e){return r.containsPosition(e)||r.end.isEqual(e)||r.start.isEqual(e)}function v(r,e){if(!e)return!1;const t=e.getRange();return r.isCollapsed?E(t,r.focus):t.containsRange(r.getFirstRange(),!0)}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/const C="restricted-editing-exception_selected";function M(r){const e=r.editing.view,t=r.model,i=new Set;e.document.registerPostFixer(n=>{const o=t.document.selection,s=g(r,o.anchor);if(!s)return!1;for(const c of r.editing.mapper.markerNameToElements(s.name))n.addClass(C,c),i.add(c);return!1}),r.conversion.for("editingDowncast").add(n=>{n.on("insert",o,{priority:"highest"}),n.on("remove",o,{priority:"highest"}),n.on("attribute",o,{priority:"highest"}),n.on("cleanSelection",o);function o(){e.change(s=>{for(const c of i.values())s.removeClass(C,c),i.delete(c)})}})}function T(r){return e=>{let t=!1;for(const{name:i,data:n}of r.model.document.differ.getChangedMarkers())i.startsWith("restrictedEditingException")&&n.newRange&&n.newRange.root.rootName=="$graveyard"&&(e.updateMarker(i,{range:e.createRange(e.createPositionAt(n.oldRange.start))}),t=!0);return t}}function y(r){return e=>{let t=!1;const i=r.model.schema;for(const n of r.model.document.differ.getChanges())n.type=="insert"&&i.checkChild("$block",n.name)&&(t=G(r,n.position,n.length,e)||t,t=K(r,n.position,n.length,e)||t);return t}}function S(r){return e=>e.on("element:span",(t,i,n)=>{const{writer:o}=n,c=new F(r.view).match(i.viewItem);if(!c)return;const d=c.match;d.name=!0;const{modelRange:a}=n.convertChildren(i.viewItem,i.modelCursor);n.consumable.consume(i.viewItem,d);const l=r.model(),u=o.createElement("$marker",{"data-name":l}),m=o.createElement("$marker",{"data-name":l});o.insert(m,a.end),o.insert(u,a.start),i.modelRange=o.createRange(o.createPositionBefore(u),o.createPositionAfter(m)),i.modelCursor=i.modelRange.end})}function G(r,e,t,i){const n=g(r,e.getShiftedBy(t));return n&&n.getStart().isEqual(e.getShiftedBy(t))?(i.updateMarker(n,{range:i.createRange(n.getStart().getShiftedBy(-t),n.getEnd())}),!0):!1}function K(r,e,t,i){const n=g(r,e);return n&&n.getEnd().isEqual(e)?(i.updateMarker(n,{range:i.createRange(n.getStart(),n.getEnd().getShiftedBy(t))}),!0):!1}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/const x="RestrictedEditingMode";class P extends f{_alwaysEnabled;_allowedInException;static get pluginName(){return"RestrictedEditingModeEditing"}static get licenseFeatureCode(){return"RED"}static get isOfficialPlugin(){return!0}static get isPremiumPlugin(){return!0}constructor(e){super(e),e.config.define("restrictedEditing",{allowedCommands:["bold","italic","link","unlink"],allowedAttributes:["bold","italic","linkHref"]}),this._alwaysEnabled=new Set(["undo","redo"]),this._allowedInException=new Set(["input","insertText","delete","deleteForward"])}init(){const e=this.editor,t=e.editing.view;e.config.get("restrictedEditing.allowedCommands").forEach(n=>this._allowedInException.add(n)),this._setupConversion(),this._setupCommandsToggling(),this._setupRestrictions(),e.commands.add("goToPreviousRestrictedEditingException",new h(e,"backward")),e.commands.add("goToNextRestrictedEditingException",new h(e,"forward")),this.listenTo(t.document,"tab",(n,o)=>{const s=o.shiftKey?"goToPreviousRestrictedEditingException":"goToNextRestrictedEditingException";e.commands.get(s).isEnabled&&(e.execute(s),o.preventDefault(),o.stopPropagation()),n.stop()},{context:"$capture"}),e.keystrokes.set("Ctrl+A",j(e)),t.change(n=>{for(const o of t.document.roots)n.addClass("ck-restricted-editing_mode_restricted",o)}),e.data.on("set",()=>{e.model.change(n=>{for(const o of e.model.markers.getMarkersGroup("restrictedEditingException"))n.removeMarker(o.name)})},{priority:"high"})}enableCommand(e){this.editor.commands.get(e).clearForceDisabled(x),this._alwaysEnabled.add(e)}_setupConversion(){const e=this.editor,i=e.model.document;let n=0;e.conversion.for("upcast").add(S({view:{name:"span",classes:"restricted-editing-exception"},model:()=>(n++,`restrictedEditingException:${n}`)})),e.conversion.for("downcast").add(o=>{o.on("addMarker:restrictedEditingException",(s,c,d)=>{if(!c.item||c.item.is("selection")||!d.schema.isInline(c.item)||!d.consumable.consume(c.item,s.name))return;const a=d.writer,l=a.createAttributeElement("span",{class:"restricted-editing-exception"},{id:c.markerName,priority:-10}),u=d.mapper.toViewRange(c.range),m=a.wrap(u,l);for(const p of m.getItems())if(p.is("attributeElement")&&p.isSimilar(l)){d.mapper.bindElementToMarker(p,c.markerName);break}})}),e.conversion.for("downcast").markerToHighlight({model:"restrictedEditingException",view:()=>({name:"span",classes:"restricted-editing-exception",priority:-10})}),e.conversion.for("editingDowncast").markerToElement({model:"restrictedEditingException",view:(o,{writer:s})=>s.createUIElement("span",{class:"restricted-editing-exception restricted-editing-exception_collapsed"})}),e.conversion.for("dataDowncast").markerToElement({model:"restrictedEditingException",view:(o,{writer:s})=>s.createEmptyElement("span",{class:"restricted-editing-exception"})}),i.registerPostFixer(y(e)),i.registerPostFixer(T(e)),i.registerPostFixer(X(e)),M(e)}_setupRestrictions(){const e=this.editor,t=e.model,i=t.document.selection,n=e.editing.view.document,o=e.plugins.get("ClipboardPipeline");this.listenTo(t,"deleteContent",J(e),{priority:"high"});const s=e.commands.get("insertText");s&&this.listenTo(s,"execute",Q(e),{priority:"high"}),this.listenTo(o,"contentInsertion",d=>{k(e,i.getFirstRange())||d.stop()}),this.listenTo(n,"clipboardOutput",(d,a)=>{a.method=="cut"&&!k(e,i.getFirstRange())&&d.stop()},{priority:"high"});const c=e.config.get("restrictedEditing.allowedAttributes");t.schema.addAttributeCheck(Y(c)),t.schema.addChildCheck(Z())}_setupCommandsToggling(){const i=this.editor.model.document;this._disableCommands(),this.listenTo(i.selection,"change",this._checkCommands.bind(this)),this.listenTo(i,"change:data",this._checkCommands.bind(this))}_checkCommands(){const e=this.editor,t=e.model.document.selection;if(t.rangeCount>1){this._disableCommands();return}const i=g(e,t.focus);this._disableCommands(),v(t,i)&&this._enableCommands(i)}_enableCommands(e){const t=this.editor;for(const[i,n]of t.commands)!n.affectsData||this._alwaysEnabled.has(i)||this._allowedInException.has(i)&&(z(i,t.model.document.selection,e.getRange())||n.clearForceDisabled(x))}_disableCommands(){const e=this.editor;for(const[t,i]of e.commands)!i.affectsData||this._alwaysEnabled.has(t)||i.forceDisabled(x)}}function j(r){return(e,t)=>{const i=r.model,n=r.model.document.selection,o=g(r,n.focus);if(!o)return;const s=n.getFirstRange();(o.getRange().containsRange(s,!0)||n.isCollapsed)&&(t(),i.change(d=>{d.setSelection(o.getRange())}))}}function z(r,e,t){return!!(r=="delete"&&t.start.isEqual(e.focus)||r=="deleteForward"&&e.isCollapsed&&t.end.isEqual(e.focus))}function J(r){return(e,t)=>{const[i]=t,n=g(r,i.focus)||g(r,i.anchor);if(!n){e.stop();return}if(i.isCollapsed)return;const o=n.getRange().getIntersection(i.getFirstRange());i.is("documentSelection")?r.model.change(s=>{s.setSelection(o)}):i.setTo(o)}}function Q(r){return(e,t)=>{const[i]=t,{range:n}=i;n&&(k(r,n)||e.stop())}}function k(r,e){const t=g(r,e.start),i=g(r,e.end);return t&&i&&i===t}function X(r){return e=>{let t=!1;const i=r.model.document.differ.getChangedMarkers();for(const{data:n,name:o}of i){if(!o.startsWith("restrictedEditingException"))continue;const s=n.newRange;if(!n.oldRange&&!s.isFlat){const c=s.start,d=s.end,a=c.path.length>d.path.length,l=a?s.start:e.createPositionAt(d.parent,0),u=a?e.createPositionAt(c.parent,"end"):s.end;e.updateMarker(o,{range:e.createRange(l,u)}),t=!0}}return t}}function Y(r){return(e,t)=>{if(e.startsWith("$clipboardHolder"))return r.includes(t)}}function Z(){return(r,e)=>{if(r.startsWith("$clipboardHolder"))return e.name==="$text"}}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class I extends f{static get pluginName(){return"RestrictedEditingModeUI"}static get isOfficialPlugin(){return!0}init(){const e=this.editor,t=e.t;e.ui.componentFactory.add("restrictedEditing",i=>{const n=V(i),o=new U;return this._getButtonDefinitions().forEach(({commandName:s,label:c,keystroke:d})=>{o.add(this._getButtonDefinition(s,c,d))}),O(n,o,{role:"menu"}),n.buttonView.set({label:t("Navigate editable regions"),icon:w,tooltip:!0,isEnabled:!0,isOn:!1}),this.listenTo(n,"execute",s=>{const{_commandName:c}=s.source;e.execute(c),e.editing.view.focus()}),n}),e.ui.componentFactory.add("menuBar:restrictedEditing",i=>{const n=new H(i),o=new L(i);return o.set({ariaLabel:t("Navigate editable regions"),role:"menu"}),n.buttonView.set({label:t("Navigate editable regions"),icon:w}),n.panelView.children.add(o),this._getButtonDefinitions().forEach(({commandName:s,label:c,keystroke:d})=>{const a=new q(i,n),l=this._createMenuBarButton(c,s,d);l.delegate("execute").to(n),a.children.add(l),o.items.add(a)}),n})}_createMenuBarButton(e,t,i){const n=this.editor,o=n.commands.get(t),s=new _(n.locale);return s.set({label:e,keystroke:i,isEnabled:!0,isOn:!1}),s.bind("isEnabled").to(o),this.listenTo(s,"execute",()=>{n.execute(t),n.editing.view.focus()}),s}_getButtonDefinition(e,t,i){const o=this.editor.commands.get(e),s={type:"button",model:new $({label:t,withText:!0,keystroke:i,withKeystroke:!0,role:"menuitem",_commandName:e})};return s.model.bind("isEnabled").to(o,"isEnabled"),s}_getButtonDefinitions(){const e=this.editor.locale.t;return[{commandName:"goToPreviousRestrictedEditingException",label:e("Previous editable region"),keystroke:"Shift+Tab"},{commandName:"goToNextRestrictedEditingException",label:e("Next editable region"),keystroke:"Tab"}]}}function ee(r,{insertAt:e}={}){if(typeof document>"u")return;const t=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css",window.litNonce&&i.setAttribute("nonce",window.litNonce),e==="top"&&t.firstChild?t.insertBefore(i,t.firstChild):t.appendChild(i),i.styleSheet?i.styleSheet.cssText=r:i.appendChild(document.createTextNode(r))}ee(":root{--ck-color-restricted-editing-exception-background:rgba(255,169,77,.2);--ck-color-restricted-editing-exception-hover-background:rgba(255,169,77,.35);--ck-color-restricted-editing-exception-brackets:rgba(204,105,0,.4);--ck-color-restricted-editing-selected-exception-background:rgba(255,169,77,.5);--ck-color-restricted-editing-selected-exception-brackets:rgba(204,105,0,.6)}.ck-editor__editable .restricted-editing-exception{background-color:var(--ck-color-restricted-editing-exception-background);border:1px solid;border-image:linear-gradient(to right,var(--ck-color-restricted-editing-exception-brackets) 0,var(--ck-color-restricted-editing-exception-brackets) 5px,transparent 6px,transparent calc(100% - 6px),var(--ck-color-restricted-editing-exception-brackets) calc(100% - 5px),var(--ck-color-restricted-editing-exception-brackets) 100%) 1;transition:background .2s ease-in-out}@media (prefers-reduced-motion:reduce){.ck-editor__editable .restricted-editing-exception{transition:none}}.ck-editor__editable .restricted-editing-exception.restricted-editing-exception_selected{background-color:var(--ck-color-restricted-editing-selected-exception-background);border-image:linear-gradient(to right,var(--ck-color-restricted-editing-selected-exception-brackets) 0,var(--ck-color-restricted-editing-selected-exception-brackets) 5px,var(--ck-color-restricted-editing-selected-exception-brackets) calc(100% - 5px),var(--ck-color-restricted-editing-selected-exception-brackets) 100%) 1}.ck-editor__editable .restricted-editing-exception.restricted-editing-exception_collapsed{padding-left:1ch}.ck-restricted-editing_mode_restricted,.ck-restricted-editing_mode_restricted *{cursor:default}.ck-restricted-editing_mode_restricted .restricted-editing-exception,.ck-restricted-editing_mode_restricted .restricted-editing-exception *{cursor:text}.ck-restricted-editing_mode_restricted .restricted-editing-exception:hover{background:var(--ck-color-restricted-editing-exception-hover-background)}");/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class te extends f{static get pluginName(){return"RestrictedEditingMode"}static get isOfficialPlugin(){return!0}static get requires(){return[P,I]}}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class A extends b{refresh(){const e=this.editor.model,t=e.document;this.value=!!t.selection.getAttribute("restrictedEditingException"),this.isEnabled=e.schema.checkAttributeInSelection(t.selection,"restrictedEditingException")}execute(e={}){const t=this.editor.model,n=t.document.selection,o=e.forceValue===void 0?!this.value:e.forceValue;t.change(s=>{const c=t.schema.getValidRanges(n.getRanges(),"restrictedEditingException");if(n.isCollapsed)if(o)s.setSelectionAttribute("restrictedEditingException",o);else{const d=m=>m.item.getAttribute("restrictedEditingException")===this.value,a=n.focus,l=a.getLastMatchingPosition(d,{direction:"backward"}),u=a.getLastMatchingPosition(d);s.removeSelectionAttribute("restrictedEditingException"),a.isEqual(l)||a.isEqual(u)||s.removeAttribute("restrictedEditingException",s.createRange(l,u))}else for(const d of c)o?s.setAttribute("restrictedEditingException",o,d):s.removeAttribute("restrictedEditingException",d)})}}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class B extends f{static get pluginName(){return"StandardEditingModeEditing"}static get isOfficialPlugin(){return!0}init(){const e=this.editor;e.model.schema.extend("$text",{allowAttributes:["restrictedEditingException"]}),e.conversion.for("upcast").elementToAttribute({model:"restrictedEditingException",view:{name:"span",classes:"restricted-editing-exception"}}),e.conversion.for("downcast").attributeToElement({model:"restrictedEditingException",view:(t,{writer:i})=>{if(t)return i.createAttributeElement("span",{class:"restricted-editing-exception"},{priority:-10})}}),e.commands.add("restrictedEditingException",new A(e)),e.editing.view.change(t=>{for(const i of e.editing.view.document.roots)t.addClass("ck-restricted-editing_mode_standard",i)})}}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class N extends f{static get pluginName(){return"StandardEditingModeUI"}static get isOfficialPlugin(){return!0}init(){const e=this.editor;e.ui.componentFactory.add("restrictedEditingException",()=>{const t=this._createButton(W);return t.set({tooltip:!0,isToggleable:!0}),t}),e.ui.componentFactory.add("menuBar:restrictedEditingException",()=>this._createButton(_))}_createButton(e){const t=this.editor,i=t.locale,n=this.editor.commands.get("restrictedEditingException"),o=new e(i),s=i.t;return o.icon=D,o.bind("isOn","isEnabled").to(n,"value","isEnabled"),o.bind("label").to(n,"value",c=>s(c?"Disable editing":"Enable editing")),this.listenTo(o,"execute",()=>{t.execute("restrictedEditingException"),t.editing.view.focus()}),o}}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class ie extends f{static get pluginName(){return"StandardEditingMode"}static get isOfficialPlugin(){return!0}static get requires(){return[B,N]}}export{A as RestrictedEditingExceptionCommand,te as RestrictedEditingMode,P as RestrictedEditingModeEditing,h as RestrictedEditingModeNavigationCommand,I as RestrictedEditingModeUI,ie as StandardEditingMode,B as StandardEditingModeEditing,N as StandardEditingModeUI,y as _extendRestrictedEditingMarkerOnTypingPostFixer,g as _getRestrictedEditingMarkerAtPosition,E as _isRestrictedEditingPositionInRangeBoundaries,v as _isRestrictedEditingSelectionInMarker,T as _resurrectRestrictedEditingCollapsedMarkerPostFixer,M as _setupRestrictedEditingExceptionHighlighting,S as _upcastRestrictedEditingHighlightToMarker};
